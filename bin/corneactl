#!/usr/bin/env perl
use strict;

# TODO fix the lib path to be better (or install)
use lib 'perl/lib';
use Cornea;
use Cornea::RecallTable;
use Cornea::Utils;
use Getopt::Long;
use YAML;
use Carp;
use Cornea::Config;
use Socket;
use Switch;

my $conf_file;
GetOptions("c=s" => \$conf_file);
my $conf = Cornea::Config->new($conf_file);

my $cmd = shift;
switch($cmd) {
  case 'list-nodes' {
    my $rt = Cornea::RecallTable->new();
    print Dump($rt->getNodes());
  }
  case 'update-node' {
    my $ip = Cornea::Utils::my_ip();
    my $fqdn = shift;
    my $location = shift;
    if(defined $fqdn) {
      # Adding a dot forces it to resolve outside search domains
      my @addr = gethostbyname("$fqdn.");
      die "fqdn '$fqdn' does not map to $ip\n"
        unless eval { $ip eq inet_ntoa($addr[4]); };
    }
    my $rt = Cornea::RecallTable->new();
    my ($total, $used) = Cornea::Utils::fsinfo($conf->get('Storage::base')."/.");
    my $min = $conf->get('Storage::minimum');
    $min = ($1*Cornea::Utils::units($2))/1024
      if ($min =~ /^(\d+)\s*([GBKMT])/i);
    my $state = (($total - $used) < $min) ? 'closed' : 'open';
    $rt->updateNode($ip, { fqdn => $fqdn,
                           state => $state,
                           total_storage => $total,
                           used_storage => $used,
                           location => $location,
                         } );
  }
  else {
    usage();
    exit();
  }
}

1;
